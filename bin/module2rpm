#!/usr/bin/env raku

use JSON::Fast;
use File::Temp;

use Module2Rpm::Download::Curl;
use Module2Rpm::Download::Git;
use Module2Rpm::Archive::Tar;
use Module2Rpm::Spec;
use Module2Rpm::Package;
use Module2Rpm::Helper;

my $helper = Module2Rpm::Helper.new;

#| Downloads, creates spec files and uploads them to OBS for all modules given in a file.
multi sub MAIN(:$file) {
    # Go through the file line by line.
    # Each line is handled as URL and expect to retrieve a json with meta information.
    # Download module source code.
    # Write Spec file.
    # Upload to OBS.
    # Repeat.
}

#| Downloads, creates spec file and uploads to OBS a given module.
multi sub MAIN(:$module) {
    say "Fetch module metadata...";
    my %all-metadata = $helper.fetch-metadata();

    my $module-metadata = %all-metadata{$module};
    die "Did not find metadata for module '$module'" unless $module-metadata;

    my $spec = Module2Rpm::Spec.new(metadata => $module-metadata);
    my $package = Module2Rpm::Package.new(spec => $spec, path => "packages".IO);

    say "Download module source...";
    $package.Download();

    say "Write spec file...";
    $package.write-spec-file();

    say "Done";
}

